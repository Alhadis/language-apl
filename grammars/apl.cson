name: "APL"
scopeName: "source.apl"
fileTypes: ["apl", "dyalog"]
firstLineMatch: '^#!.*\\b(apl|dyalog)'
foldingStartMarker: '\\{'
foldingStopMarker:  '\\}'
patterns: [
	
	{ include: "#main" }
	
	
	# Shebang
	{
		match: "\\A#!.*$"
		name:  "comment.line.shebang.apl"
	}
	
	
	# System variables
	{
		match: "(⎕)[A-Z]*"
		name: "support.system.variable.apl"
		captures:
			1: {name: "punctuation.definition.quad.apl"}
	}
	
	
	# System commands
	{
		name: "meta.system.command.apl"
		begin: "^\\s*(\\)\\S+)"
		end:   "$"
		beginCaptures:
			1: {name: "entity.name.command.apl"}
		patterns: [
			{ include: "#command-arguments" }
			{ include: "#command-switches"  }
			{ include: "#main" }
		]
	}
	
	
	# User commands
	{
		name: "meta.user.command.apl"
		begin: "^\\s*(\\]\\S+)"
		end:   "$"
		beginCaptures:
			1: {name: "entity.name.command.apl"}
		patterns: [
			{ include: "#command-arguments" }
			{ include: "#command-switches"  }
			{ include: "#main" }
		]
	}
	
	
	
	# MISC
	#=====================================================================
	{match: ";",       name: "keyword.operator.semicolon.apl"}
	{match: "¯",       name: "keyword.operator.high-minus.apl"}
	{match: "←",       name: "keyword.operator.assignment.apl"}
	{match: "→",       name: "keyword.control.goto.apl"}
	
	
	
	# FUNCTIONS
	#=====================================================================
	# Monadic or Dyadic, depending on context
	{match: "\\?",     name: "keyword.operator.random.apl"}
	{match: "⌈",       name: "keyword.operator.ceiling.apl"}
	{match: "⌊",       name: "keyword.operator.floor.apl"}
	{match: "⍴",       name: "keyword.operator.rho.apl"}
	{match: "[∼~]",    name: "keyword.operator.tilde.apl"}
	{match: "[∣|]",    name: "keyword.operator.absolute.apl"}
	{match: "⍳",       name: "keyword.operator.iota.apl"}
	{match: "[⋆*]",    name: "keyword.operator.exponent.apl"}
	{match: "[-−]",    name: "keyword.operator.minus.apl"}
	{match: "\\+",     name: "keyword.operator.plus.apl"}
	{match: "×",       name: "keyword.operator.times.apl"}
	{match: "÷",       name: "keyword.operator.divide.apl"}
	{match: ",",       name: "keyword.operator.catenate.apl"}
	{match: "⌹",       name: "keyword.operator.quad-divide.apl"}
	{match: "○",       name: "keyword.operator.circle.apl"}
	{match: "⍟",       name: "keyword.operator.logarithm.apl"}
	{match: "⌽",       name: "keyword.operator.rotate-last.apl"}
	{match: "⊖",       name: "keyword.operator.rotate-first.apl"}
	{match: "⍕",       name: "keyword.operator.format.apl"}
	{match: "⍉",       name: "keyword.operator.transpose.apl"}
	{match: "!",       name: "keyword.operator.factorial.apl"}
	
	
	# Monadic-only
	{match: "⍋",       name: "keyword.operator.grade-up.apl"}
	{match: "⍒",       name: "keyword.operator.grade-down.apl"}
	{match: "⍎",       name: "keyword.operator.execute.apl"}
	
	
	# Dyadic-only functions
	{match: "∈",       name: "keyword.operator.member-of.apl"}
	{match: "↑",       name: "keyword.operator.take.apl"}
	{match: "↓",       name: "keyword.operator.drop.apl"}
	{match: "⊥",       name: "keyword.operator.decode.apl"}
	{match: "⊤",       name: "keyword.operator.encode.apl"}
	{match: "\\x5C",   name: "keyword.operator.backslash.apl"}
	{match: "\\/",     name: "keyword.operator.slash.apl"}
	{match: "¨",       name: "keyword.operator.each.apl"}
	{match: "<",       name: "keyword.operator.less.apl"}
	{match: "≤",       name: "keyword.operator.less-or-equal.apl"}
	{match: "=",       name: "keyword.operator.equal.apl"}
	{match: "≥",       name: "keyword.operator.greater-or-equal.apl"}
	{match: ">",       name: "keyword.operator.greater.apl"}
	{match: "≠",       name: "keyword.operator.not-equal.apl"}
	{match: "∨",       name: "keyword.operator.or.apl"}
	{match: "∧",       name: "keyword.operator.and.apl"}
	{match: "⍱",       name: "keyword.operator.nor.apl"}
	{match: "⍲",       name: "keyword.operator.nand.apl"}
	
	# Operators
	{match: "⌿",       name: "keyword.operator.slash-bar.apl"}
	{match: "⍀",       name: "keyword.operator.backslash-bar.apl"}
	{match: "\\.",     name: "keyword.operator.inner-product.apl"}
	{match: "∘\\.",    name: "keyword.operator.outer-product.apl"}
]



repository:
	
	# Common patterns
	main: {
		patterns:[
			{ include: "#comment" }
			{ include: "#strings" }
			{ include: "#float"   }
			{ include: "#int"     }
			{ include: "#name"    }
		]
	}
	
	
	# Comment-lines
	comment:
		name:  "comment.line.apl"
		begin: "⍝"
		end:   "$"
		captures:
			0: {name: "punctuation.definition.comment.apl"}
	
	
	# Floating-point numbers
	float: {
		patterns: [{
			name:  "constant.numeric.float.apl"
			match: '(?<!\\$)\\b(\\d+)(\\.)(\\d+([Ee]([\\+\\-])?\\d+)?)\\b'
			captures:
				1: {name: "leading.decimal"}
				2: {name: "decimal.separator"}
				3: {name: "trailing.decimal"}
				4: {name: "exponential.decimal"}
		}, {
			name:  "constant.numeric.float.no-trailing-digits.apl"
			match: '\\b(\\d+)(\\.)(?!\\w)'
			captures:
				1: {name: "leading.decimal"}
				2: {name: "decimal.separator"}
		}, {
			name:  "constant.numeric.float.no-leading-digits.apl"
			match: '(?<!\\w)(\\.)(\\d+([Ee]([\\+\\-])?\\d+)?)\\b'
			captures: {
				1: {name: "decimal.separator"}
				2: {name: "trailing.decimal"}
				3: {name: "exponential.decimal"}
			}
		}]
	}
	
	
	# Integers
	int: {
		patterns: [{
			name:  "constant.numeric.int.apl"
			match: '(?<!\\$)\\b\\d+\\b'
		}]
	}
	
	
	# String literals
	strings:
		patterns: [{
			name: "string.quoted.single.apl"
			begin: "'"
			end:   "'|$"
			beginCaptures:
				0: {name: "punctuation.definition.string.begin.apl"}
			endCaptures:
				0: {name: "punctuation.definition.string.end.apl"}
			patterns: [{
				match: "[^']*[^'\\n\\r\\\\]$"
				name: "invalid.illegal.string.apl"
			}]
		}, {
			name: "string.quoted.double.apl",
			begin: '"'
			end:   '"|$'
			beginCaptures:
				0: {name: "punctuation.definition.string.begin.apl"}
			endCaptures:
				0: {name: "punctuation.definition.string.end.apl"}
			patterns: [{
				match: '[^"]*[^"\\n\\r\\\\]$'
				name: "invalid.illegal.string.apl"
			}]
		}]

	
	# Names
	name:
		patterns: [{
			name: "storage.type.name.apl"
			match: "[A-Za-z0-9∆⍙_]+[A-Za-z0-9∆⍙_¯]*"
		}]


	
	# Command arguments
	"command-arguments":
		patterns: [{
			name: "variable.parameter.argument.apl"
			begin: "\\b(?=\\S)"
			end:   "\\b(?=\\s)"
			patterns: [{include: "#main"}]
		}]
	
	# Switches (Dyalog-specific feature)
	"command-switches":
		patterns: [{
			name: "variable.parameter.switch.apl"
			begin: "(?<=\\s)(-)([A-Za-z0-9∆⍙_]+[A-Za-z0-9∆⍙_¯]*)(=)"
			end:   "\\b(?=[\\s⍝])"
			beginCaptures:
				1: {name: "punctuation.delimiter.switch.apl"}
				2: {name: "entity.name.switch.apl"}
				3: {name: "punctuation.assignment.switch.apl"}
		}]
